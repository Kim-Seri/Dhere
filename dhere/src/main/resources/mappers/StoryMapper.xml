<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
	<mapper namespace="com.springstudy.dhere.mappers.StoryMapper">
	
		<!-- 스토리 게시물 출력 (스토리, 이미지, 프로필) -->
		<select id="getStoryList"  resultMap="StoryResultMap">
			SELECT 
			    s.story_no,
			    s.title,
			    s.content,
			    s.email,
			    s.reg_date,
			    s.category_no,
			    s.read_count,
			    s.thank,
			    s.nickname,
			    i.file_name,
			    m.picture 
			FROM 
			    story s
			LEFT JOIN 
			    image i ON s.story_no = i.story_no
			LEFT JOIN 
			    member m ON s.email = m.email
			WHERE
			    i.image_no = (SELECT MIN(image_no) FROM image WHERE story_no = s.story_no)
		</select>
	
	<!-- 스토리 result map -->
		<resultMap id="StoryResultMap" type="Story">
				<id property="storyNo" column="story_no" />
				<result property="title" column="title" />
				<result property="content" column="content" />
				<result property="email" column="email" />
				<result property="regDate" column="reg_date" />
				<result property="categoryNo" column="category_no" />
				<result property="readCount" column="read_count" />
				<result property="thank" column="thank" />
				<result property="nickname" column="nickname" />
				<result property="thumbnail" column="file_name" />
				<result property="profile" column="picture" />
		</resultMap>

	<!-- 스토리 게시글 작성 쿼리 -->
		<insert id="postWrite" parameterType="story">
			INSERT INTO story(title,content,email,reg_date,category_no,nickname)
			VALUES(#{title},#{content},#{email},SYSDAYE(),#{categoryNo},#{nickname})
		
			<selectKey keyProperty="storyNo" order="AFTER"
				resultType="int">
				SELECT LAST_INSERT_ID()
			</selectKey>
		</insert>

	
	<!-- 스토리 이미지 작성 쿼리 -->
	 <insert id="insertImage" parameterType="Image">
        INSERT INTO image (file_name, story_no)
        VALUES (#{fileName}, #{storyNo})
    </insert>

	<!-- 게시물 상세보기 쿼리 -->
	<select id="getStoryDetail" resultType="Story">
		    SELECT 
		        s.story_no as storyNo,
		        s.title,
		        s.content,
		        s.email,
		        s.reg_date as regDate,
		        s.category_no as categoryNo,
		        s.read_count as readCount,
		        s.thank,
		        s.nickname,
		        i.image_no as imageNo,
		        i.file_name as fileName
		    FROM story s
		    LEFT JOIN image i ON s.story_no = i.story_no
		    WHERE s.story_no = #{storyNo}
		</select>
		
	</mapper>
